name: Flutter CD

on:
  push:
    tags:
      - 'v*'

jobs:
  release_android:
    name: Build and Release Android App
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.3'
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
        
      - name: Build APK
        run: flutter build apk --release
      
      - name: Build App Bundle
        run: flutter build appbundle --release
        
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab
          name: Release ${{ github.ref_name }}
          body: |
            # Release ${{ github.ref_name }}
            
            ì´ ë¦´ë¦¬ìŠ¤ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
            
            ## ë‹¤ìš´ë¡œë“œ
            - [APK ë‹¤ìš´ë¡œë“œ](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/app-release.apk)
            - [AAB ë‹¤ìš´ë¡œë“œ](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/app-release.aab)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Discord notification - Release Success
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "ğŸš€ ìƒˆë¡œìš´ ë¦´ë¦¬ìŠ¤ê°€ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤"
          description: |
            ë¦´ë¦¬ìŠ¤: [${{ github.ref_name }}](https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }})
            ì €ì¥ì†Œ: ${{ github.repository }}
            
            ë¦´ë¦¬ìŠ¤ê°€ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤. GitHub Releases í˜ì´ì§€ì—ì„œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          color: 0x43B581
  
  release_ios:
    name: Build iOS for Release
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.3'
          channel: 'stable'
          cache: true
      
      # Ruby ì„¤ì • ë° xcodeproj ì„¤ì¹˜
      - name: Setup Ruby and required gems
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
      
      - name: Install required gems
        run: gem install xcodeproj
      
      - name: Install dependencies
        run: flutter pub get
        
      - name: Build iOS for Release
        run: flutter build ios --release --no-codesign
        
      - name: Create Release Note
        uses: softprops/action-gh-release@v1
        with:
          files: |
            # ì‹¤ì œ ë°°í¬ íŒŒì¼ì´ ì—†ìœ¼ë¯€ë¡œ ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ë§Œ ì—…ë°ì´íŠ¸
          name: iOS Release ${{ github.ref_name }}
          body: |
            # iOS Release ${{ github.ref_name }}
            
            ì´ iOS ë¦´ë¦¬ìŠ¤ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
            iOS ì•±ì„ ì‹¤ì œë¡œ ë°°í¬í•˜ë ¤ë©´ App Store Connectë¥¼ í†µí•´ ìˆ˜ë™ìœ¼ë¡œ ì—…ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Discord notification - iOS Build Success
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "ğŸ iOS ë¦´ë¦¬ìŠ¤ ë¹Œë“œ ì™„ë£Œ"
          description: |
            ë¦´ë¦¬ìŠ¤: [${{ github.ref_name }}](https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }})
            ì €ì¥ì†Œ: ${{ github.repository }}
            
            iOS ë¦´ë¦¬ìŠ¤ ë¹Œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. App Store Connectì— ìˆ˜ë™ìœ¼ë¡œ ì—…ë¡œë“œí•˜ì„¸ìš”.
          color: 0x43B581 