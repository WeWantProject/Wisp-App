name: Flutter CD

on:
  push:
    tags:
      - 'v*'

jobs:
  release_android:
    name: Build and Release Android App
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.3'
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
        
      - name: Build APK
        run: flutter build apk --release
      
      - name: Build App Bundle
        run: flutter build appbundle --release
        
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab
          name: Release ${{ github.ref_name }}
          body: |
            # Release ${{ github.ref_name }}
            
            이 릴리스는 자동으로 생성되었습니다.
            
            ## 다운로드
            - [APK 다운로드](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/app-release.apk)
            - [AAB 다운로드](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/app-release.aab)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Discord notification - Release Success
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "🚀 새로운 릴리스가 배포되었습니다"
          description: |
            릴리스: [${{ github.ref_name }}](https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }})
            저장소: ${{ github.repository }}
            
            릴리스가 성공적으로 배포되었습니다. GitHub Releases 페이지에서 다운로드할 수 있습니다.
          color: 0x43B581
  
  release_ios:
    name: Build iOS for Release
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.3'
          channel: 'stable'
          cache: true
      
      # Ruby 설정 및 xcodeproj 설치
      - name: Setup Ruby and required gems
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
      
      - name: Install required gems
        run: gem install xcodeproj
      
      - name: Install dependencies
        run: flutter pub get
        
      - name: Build iOS for Release
        run: flutter build ios --release --no-codesign
        
      - name: Create Release Note
        uses: softprops/action-gh-release@v1
        with:
          files: |
            # 실제 배포 파일이 없으므로 릴리스 노트만 업데이트
          name: iOS Release ${{ github.ref_name }}
          body: |
            # iOS Release ${{ github.ref_name }}
            
            이 iOS 릴리스는 자동으로 생성되었습니다.
            iOS 앱을 실제로 배포하려면 App Store Connect를 통해 수동으로 업로드해야 합니다.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Discord notification - iOS Build Success
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "🍎 iOS 릴리스 빌드 완료"
          description: |
            릴리스: [${{ github.ref_name }}](https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }})
            저장소: ${{ github.repository }}
            
            iOS 릴리스 빌드가 완료되었습니다. App Store Connect에 수동으로 업로드하세요.
          color: 0x43B581 